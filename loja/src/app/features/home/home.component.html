<section class="welcome">
  <div>
    <p class="badge">Autenticado como {{ papelAtual() }}</p>
    <h1>Catálogo La Couro</h1>
    <p>
      Clientes podem visualizar o catálogo publicado e criar pedidos. Se você for ADMIN, use o atalho abaixo para
      abrir o painel dedicado.
    </p>
    <div class="actions">
      <a routerLink="/login">Trocar usuário</a>
      <a *ngIf="isAdmin()" routerLink="/admin/painel" class="primary">Ir para painel do admin</a>
    </div>
  </div>
  <div class="resume">
    <p>Produtos publicados: <strong>{{ produtos().length }}</strong></p>
    <p *ngIf="isClient()">Meus pedidos: <strong>{{ pedidos().length }}</strong></p>
  </div>
</section>

<section class="grid">
  <article class="card">
    <header class="card-title">
      <p class="badge">Produtos</p>
      <div class="actions">
        <button type="button" class="link" (click)="carregarProdutos()" [disabled]="loadingProdutos()">
          Recarregar
        </button>
      </div>
      <h2>Disponíveis para compra</h2>
    </header>

    <p *ngIf="feedback()" class="feedback">{{ feedback() }}</p>

    <div class="products" *ngIf="!loadingProdutos(); else loadingProdutosTpl">
      <p *ngIf="!produtos().length" class="muted">Nenhum item publicado ainda.</p>
      <div class="product-grid">
        <div class="product" *ngFor="let produto of produtos()">
          <div class="product-img" *ngIf="produto.fotoUrl">
            <img [src]="produto.fotoUrl" [alt]="produto.nome" />
          </div>
          <div class="product-info">
            <h3>{{ produto.nome }}</h3>
            <p>{{ produto.tamanho }} • {{ produto.cor }}</p>
            <p class="price">R$ {{ produto.preco | number: '1.2-2' }}</p>
            <small>Estoque: {{ produto.quantidadeEstoque ?? 0 }}</small>
          </div>
        </div>
      </div>
    </div>
    <ng-template #loadingProdutosTpl>
      <p class="muted">Carregando produtos...</p>
    </ng-template>

    <section *ngIf="isClient()" class="orders-flow">
      <h3>Comprar</h3>
      <p class="muted">Escolha o produto e a quantidade para gerar um pedido.</p>

      <form [formGroup]="pedidoForm" (ngSubmit)="criarPedido()" class="product-form" novalidate>
        <label>
          <span>Produto</span>
          <select formControlName="produtoId">
            <option value="" disabled>Escolha um produto</option>
            <option *ngFor="let produto of produtos()" [value]="produto.id">{{ produto.nome }}</option>
          </select>
        </label>
        <label>
          <span>Quantidade</span>
          <input type="number" min="1" formControlName="quantidade" />
        </label>
        <button type="submit">Criar pedido</button>
      </form>

      <p *ngIf="pedidoAcaoFeedback()" class="feedback">{{ pedidoAcaoFeedback() }}</p>
    </section>
  </article>

  <article class="card">
    <header class="card-title">
      <p class="badge">Pedidos</p>
      <div class="actions">
        <button type="button" class="link" (click)="carregarPedidos()" [disabled]="loadingPedidos()">
          Atualizar
        </button>
      </div>
      <h2>{{ isClient() ? 'Meus pedidos' : 'Pedidos' }}</h2>
    </header>

    <div class="orders" *ngIf="!loadingPedidos(); else loadingPedidosTpl">
      <p *ngIf="pedidoFeedback()" class="feedback">{{ pedidoFeedback() }}</p>
      <p *ngIf="!pedidos().length && !pedidoFeedback()" class="muted">Nenhum pedido encontrado.</p>

      <ul class="order-list">
        <li *ngFor="let pedido of pedidos()">
          <div class="order-head">
            <span>Pedido {{ pedido.id ?? '—' }}</span>
            <span class="status">{{ pedido.status ?? 'SEM STATUS' }}</span>
          </div>
          <p class="muted">Cliente: {{ pedido.usuarioId }}</p>
          <ul class="order-items">
            <li *ngFor="let item of pedido.itens">{{ nomeDoProduto(item.produtoId) }} ({{ item.produtoId }}) x{{ item.quantidade }}</li>
          </ul>
        </li>
      </ul>
    </div>
    <ng-template #loadingPedidosTpl>
      <p class="muted">Carregando pedidos...</p>
    </ng-template>
  </article>
</section>
